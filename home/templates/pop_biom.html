{% extends "base.html" %}

{% block container_content %}
  <link rel="stylesheet" type="text/css"  href="/static/css/barchart.css">
  <link rel="stylesheet" type="text/css"  href="/static/css/pop_biom.css">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="/static/js/barchart.js"></script>
  <script src="/static/js/sankey.js"></script>
  <!-- Please make sure jQuery is also loaded. -->
  
  <div class="container">
    <div class="row">
      <div class="col-md-12"><div style="text-align:center; display:block;">
        <img src="{{ company_logo }}?version={{ version }}" style="width: 224px;" />
      </div></div>
    {% if hm_data %}

    <div class="row">
      <p>Eligible</p>
      <div class="col-md-12" id="eligible" style="height: 44px; text-align:left; display:block;"></div>
    </div>
    <div class="row">
      <p>Participating</p>
      <div class="col-md-12" id="participating" style="height: 44px; text-align:left; display:block;"></div>
    </div>
    <div class="row">
      <p>Engaged</p>
      <div class="col-md-12" id="engaged" style="height: 44px; text-align:left; display:block;"></div>
    </div>

    <div class="row">
      <p>Members Participating</p>
      <div class="col-md-12" id="members_participating" style="height: 44px; text-align:left; display:block;"></div>
    </div>
    <div class="row">
      <p>Participating Expenses</p>
      <div class="col-md-12" id="expenses_participating" style="height: 44px; text-align:left; display:block;"></div>
    </div>

    <div class="row">
      <p>Non-Participating Members</p>
      <div class="col-md-12" id="members_non_participating" style="height: 44px; text-align:left; display:block;"></div>
    </div>
    <div class="row">
      <p>Non-Participating Expenses</p>
      <div class="col-md-12" id="expenses_non_participating" style="height: 44px; text-align:left; display:block;"></div>
    </div>

    <div class="row">
      <p>engaged Members</p>
      <div class="col-md-12" id="members_engaged" style="height: 44px; text-align:left; display:block;"></div>
    </div>
    <div class="row">
      <p>engaged Expenses</p>
      <div class="col-md-12" id="expenses_engaged" style="height: 44px; text-align:left; display:block;"></div>
    </div>

    <div class="row">
      <p>Figure 3</p>
      <div class="col-md-12" id="figure3" style="height: 44px; text-align:left; display:block;"></div>
    </div>
  {% endif %}

    <div id="hm-tabs">
      <ul class="nav nav-tabs">
        <li><a href="#pi">PROGRAM IMPACT</a></li>
        <li><a href="#op">OPPORTUNITIES</a></li>
        <li><a href="#ep">EXPLORE POPULATION</a></li>
      </ul>
      <div class="row">
	<div class="col-md-12">
<!--	  <h2>Population Health</h2> -->
	</div>
      </div>
      <div id="my-tab-content" class="tab-content">
        <div class="tab-pane active" id="pi">
        <h4>How has my population been impacted by health programs over time?</h4>
          <div class="center">
            <h4>POPULATION OVERVIEW</h4> 
            <p>Overall participation has increased <b>X%</b> in the last <b>3 years</b></p>
            <div id="total_pop" class="side-by-side div-size"></div>
            <div id="participation_rates" class="side-by-side div-size"></div>
            <div id="engagement_rates" style="display: inline-block;" class="div-size"></div>
          </div>
          <hr></hr>
          <div class="center">
            <h4>CHANGES IN COST</h4>
            <p>Per member per month cost has decreased by <b>X%</b> over the last <b>3 years</b></p>
            <div> 
	      <!--
              <div id="blank" class="side-by-side div-size" style="visibility: hidden;"></div>
              <div id="total_pmpm" class="side-by-side div-size"></div>
              <div id="blankm" class="side-by-side div-size" style="visibility: hidden;"></div>
	      -->
            </div>
              <div id="non-participant_pmpm" class="side-by-side div-size"></div>
              <div id="participant_pmpm" class="side-by-side div-size"></div>
              <div id="engaged_pmpm" style="display: inline-block;" class="div-size"></div>
              <h4>CHANGES IN UTILIZATION</h4>
              <p>Claims activity has moved in a positive direction, with <b>X%</b> of claims now under $500 and <b>Y%</b> over $10K</p>
              <div> 
                <div id="blank" class="side-by-side div-size" style="visibility: hidden;"></div>
                <div class="side-by-side div-size">
		  <div class="figure_title figure_s">Total Population Claims</div>
		  <div id="total_population_claims"></div>
		</div>
                <div id="blankm" class="side-by-side div-size" style="visibility: hidden;"></div>
              </div>
	      <!--
	      <div>
              <div id="non_participant_claims_text" class="side-by-side div-size"></div>
              <div id="participant_claims_text" class="side-by-side div-size"></div>
              <div id="engaged_claims_text" style="display: inline-block;" class="div-size"></div>
              </div> 
	      -->
	      <div>
		<div class="side-by-side div-size">
		  <div class="figure_s figure_title">Non-Participant Claims</div>
		  <div id="non_participant_claims" ></div>
		</div>
		<div class="side-by-side div-size">
		  <div class="figure_s figure_title">Participant Claims</div>
		  <div id="participant_claims" ></div>
		</div>
		<div style="display: inline-block;" class="div-size">
		  <div class="figure_s figure_title">Engaged Claims</div>
		  <div id="engaged_claims" ></div>
		</div>
	      </div>
            </div>
            <hr></hr>
            <div class="center">
              <h4>RISK DISTRIBUTION</h4>
              <p>High risk population has <b>decreased by NN%</b> over the last <b>3 years</b></p>
              <div id="participant_risk" class="side-by-side div-size-big" style="margin-right: 5px;">
	            </div>
              <div id="engaged_risk" style="display: inline-block;">
      	      </div>

              <h4>CHANGES IN RISK</h4>
              <p>Engagement resulted in <b>X%</b> of the population moving to a lower risk level in the last <b>4 years</b></p>
              <div id="changes_risk_participants" class="side-by-side div-size-big" style="margin-right: 5px;">
              </div>
              <div id="changes_risk_engaged" style="display: inline-block;">
              </div>
            </div>
            <hr></hr>
            <div class="center">
              <h4>IMPROVED BIOMETRICS</h4>
              <p>Engagement resulted in improvement for <b>X</b> biometrics:<b>Body Mass Index</b> and <b>Blood Pressure</b></p>
              <div>
                <div id="biom1_participants" class="side-by-side div-size" style="margin-bottom: 60px;">
		  <p></p>
                  <!--<div class="side-by-side div-size" style="width: 150px; height:150px; font-size: 0.75em;" > </div>-->
		</div>
                <div id="biom1_engaged" class="side-by-side div-size" style="margin-bottom: 60px;">
		  <p></p>
                  <!--<div class="side-by-side div-size" style="width: 150px; height: 150px; font-size: 0.75em;" > </div>-->
		</div>
              </div>
              <div>
                <div id="biom2_participants" class="side-by-side div-size" style="margin-bottom: 60px;">
		  <p></p>
                  <!--<div class="side-by-side div-size" style="width: 150px; height:150px; font-size: 0.75em;" > </div>-->
		</div>
                <div id="biom2_engaged" class="side-by-side div-size" style="margin-bottom: 60px;">
		  <p></p>
                  <!--<div class="side-by-side div-size" style="width: 150px; height: 150px; font-size: 0.75em;" > </div>-->
		</div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane" id="op">
          <h2>Opportunities</h2>
          <img src="static/dimages/HealthMetrics_Opportunities_v2.png?version={{ version }}">
        </div>
        <div class="tab-pane" id="ep">
          <h2>Explore Populations</h2>
          <img src="static/dimages/ExplorePopNew.png?version={{ version }}" style="margin-left: 144px; width: 800px;">
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block loadscript %}
    $("#pi").show();
    $("#op").hide();
    $("#ep").hide();

    var eligible;
    
      $.post('/rpc/1/healthmetrics/', {'func': 'non_participant_claims', 'args': JSON.stringify([])}, function(data) {
          /* $("#non_participant_claims_text").html(data); */

          var margin = {top: 70, right: 120, bottom: 20, left: 30},
              width = 300 - margin.left - margin.right,
              height = 200 - margin.top - margin.bottom;

          var x = d3.scale.ordinal()
              .rangeRoundBands([0, width], .5);

          var y = d3.scale.linear()
              .rangeRound([height, 0]);

          var color = d3.scale.ordinal()
              .range(["steelblue", "#BDBDBD", "#F78181"]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");

          var loc = "#non_participant_claims";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          data = JSON.parse(data);
          color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year"; }));

          $.each(data, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });

          data = data.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(data.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(data, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(data)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.over_10k+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.between+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.under_500+'%'; });

        }).fail(function() {
          /* $("#non_participant_claims_text").html('Error with non_participant_claims'); */
        });

      $.post('/rpc/1/healthmetrics/', {'func': 'participant_claims', 'args': JSON.stringify([])}, function(data) {
	/*
          $("#participant_claims_text").html(data);
	*/
          var margin = {top: 70, right: 120, bottom: 20, left: 30},
              width = 300 - margin.left - margin.right,
              height = 200 - margin.top - margin.bottom;

          var x = d3.scale.ordinal()
              .rangeRoundBands([0, width], .5);

          var y = d3.scale.linear()
              .rangeRound([height, 0]);

          var color = d3.scale.ordinal()
              .range(["steelblue", "#BDBDBD", "#F78181"]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");

          var loc = "#participant_claims";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          data = JSON.parse(data);
          color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year"; }));

          $.each(data, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });

          data = data.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(data.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(data, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(data)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.over_10k+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.between+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.under_500+'%'; });

        }).fail(function() {
          /* $("participant_claims_text").html('Error with participant_claims'); */
        });

      $.post('/rpc/1/healthmetrics/', {'func': 'engaged_claims', 'args': JSON.stringify([])}, function(data) {
          /* $("#engaged_claims_text").html(data); */

          var margin = {top: 70, right: 120, bottom: 20, left: 30},
              width = 300 - margin.left - margin.right,
              height = 200 - margin.top - margin.bottom;

          var x = d3.scale.ordinal()
              .rangeRoundBands([0, width], .5);

          var y = d3.scale.linear()
              .rangeRound([height, 0]);

          var color = d3.scale.ordinal()
              .range(["steelblue", "#BDBDBD", "#F78181"]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");

          var loc = "#engaged_claims";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          data = JSON.parse(data);
          color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year"; }));

          $.each(data, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });

          data = data.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(data.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(data, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(data)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.over_10k+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.between+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.under_500+'%'; });
          
        }).fail(function() {
          /* $("#engaged_claims_text").html('Error with engaged_claims'); */
        });

      $.post('/rpc/1/healthmetrics/', {'func': 'risk_participating', 'args': JSON.stringify([])}, function(data) {
          /* $("#participant_risk_text").html(data); */

          var title = "Participant Risk";

          var loc = "#participant_risk";

          var margin = {top: 80, right: 100, bottom: 50, left: 80},
              width = 400 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

          var parseDate = d3.time.format("%Y").parse;

          var x = d3.time.scale()
              .range([0, width]);

          var y = d3.scale.linear()
              .range([height-50, 0]);

          var color = d3.scale.ordinal().range(["#F78181", "#BDBDBD", "steelblue"]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .ticks(d3.time.year, 1)
              .orient("bottom");

          var line = d3.svg.line()
              .x(function(d) { return x(+d.Year); })
              .y(function(d) { return y(d.count); });

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          data = JSON.parse(data);

          color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year"; }));

          $.each(data, function(i, d) {
            d.Year = parseDate(d.Year);
          });

          var risks = color.domain().map(function(name) {
            return {
              name: name,
              counts: data.map(function(d) {
                return {Year: d.Year, count: +d[name]};
              })
            };
          });

          $.each(risks, function(i, d){
            d.counts = d.counts.sort(function(a, b) { 
              if (a.Year > b.Year) return 1;
              if (a.Year < b.Year) return -1;
              return 0;
            });
          });

          x.domain(d3.extent(data, function(d) { return +d.Year; }));

          y.domain([
            d3.min(risks, function(c) { return d3.min(c.counts, function(v) { return v.count; }); }),
            d3.max(risks, function(c) { return d3.max(c.counts, function(v) { return v.count; }); })
          ]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var risk = svg.selectAll(".risk")
              .data(risks)
            .enter().append("g")
              .attr("class", "risk");

          risk.append("path")
              .attr("class", "line")
              .attr("d", function(d) { return line(d.counts); })
              .style("stroke", function(d) { return color(d.name); });

          risk.append("text")
              .datum(function(d) { return {name: d.name, value: d.counts[d.counts.length - 1]}; })
              .attr("transform", function(d) { return "translate(" + x(+d.value.Year) + "," + y(d.value.count) + ")"; })
              .attr("x", 3)
              .attr("dx", "2.5em")
              .attr("dy", ".35em")
              .attr("fill", function(d) { return color(d.name); })
              .text(function(d) { return d.name; });

          for (var ind = risks[0].counts.length - 1; ind >= 0; ind--) {

            risk.append("rect")
              .datum(function(d) { return {name: d.name, value: d.counts[ind]}; })
              .attr("transform", function(d) { return "translate(" + x(+d.value.Year) + "," + y(d.value.count) + ")"; })
              .attr("x", -20)
              .attr("y", -8)
              .attr("width", 40)
              .attr("height", 16)
              .style("opacity", 1)
              .style("fill", "white");

            risk.append("text")
              .datum(function(d) { return {name: d.name, value: d.counts[ind]}; })
              .attr("transform", function(d) { return "translate(" + x(+d.value.Year) + "," + y(d.value.count) + ")"; })
              .attr("x", 3)
              .attr("dx", "-1em")
              .attr("dy", "0em")
              .attr("fill", function(d) { return color(d.name); })
              .text(function(d) { return d.value.count+'%'; });
          };

          svg.append("text")
              .text(title)
              .attr("x", width/2)
              .attr("y", 0)
              .style("font-size", "1.9em")
              .attr("dx", "-2.5em")
              .attr("dy", "-2em");

        }).fail(function() {
          /* $("#participant_risk_text").html('Error with risk_participating'); */
        });

      $.post('/rpc/1/healthmetrics/', {'func': 'risk_engaged', 'args': JSON.stringify([])}, function(data) {
          /* $("#engaged_risk_text").html(data); */

          var title = "Engaged Risk";

          var loc = "#engaged_risk";

          var margin = {top: 80, right: 100, bottom: 50, left: 80},
              width = 400 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

          var parseDate = d3.time.format("%Y").parse;

          var x = d3.time.scale()
              .range([0, width]);

          var y = d3.scale.linear()
              .range([height-50, 0]);

          var color = d3.scale.ordinal().range(["#F78181", "#BDBDBD", "steelblue"]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .ticks(d3.time.year, 1)
              .orient("bottom");

          var line = d3.svg.line()
              .x(function(d) { return x(+d.Year); })
              .y(function(d) { return y(d.count); });

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          data = JSON.parse(data);

          color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year"; }));

          $.each(data, function(i, d) {
            d.Year = parseDate(d.Year);
          });

          var risks = color.domain().map(function(name) {
            return {
              name: name,
              counts: data.map(function(d) {
                return {Year: d.Year, count: +d[name]};
              })
            };
          });

          $.each(risks, function(i, d){
            d.counts = d.counts.sort(function(a, b) { 
              if (a.Year > b.Year) return 1;
              if (a.Year < b.Year) return -1;
              return 0;
            });
          });

          x.domain(d3.extent(data, function(d) { return +d.Year; }));

          y.domain([
            d3.min(risks, function(c) { return d3.min(c.counts, function(v) { return v.count; }); }),
            d3.max(risks, function(c) { return d3.max(c.counts, function(v) { return v.count; }); })
          ]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var risk = svg.selectAll(".risk")
              .data(risks)
            .enter().append("g")
              .attr("class", "risk");

          risk.append("path")
              .attr("class", "line")
              .attr("d", function(d) { return line(d.counts); })
              .style("stroke", function(d) { return color(d.name); });

          risk.append("text")
              .datum(function(d) { return {name: d.name, value: d.counts[d.counts.length - 1]}; })
              .attr("transform", function(d) { return "translate(" + x(+d.value.Year) + "," + y(d.value.count) + ")"; })
              .attr("x", 3)
              .attr("dx", "2.5em")
              .attr("dy", ".35em")
              .attr("fill", function(d) { return color(d.name); })
              .text(function(d) { return d.name; });

          for (var ind = risks[0].counts.length - 1; ind >= 0; ind--) {

            risk.append("rect")
              .datum(function(d) { return {name: d.name, value: d.counts[ind]}; })
              .attr("transform", function(d) { return "translate(" + x(+d.value.Year) + "," + y(d.value.count) + ")"; })
              .attr("x", -20)
              .attr("y", -8)
              .attr("width", 40)
              .attr("height", 16)
              .style("opacity", 1)
              .style("fill", "white");

            risk.append("text")
              .datum(function(d) { return {name: d.name, value: d.counts[ind]}; })
              .attr("transform", function(d) { return "translate(" + x(+d.value.Year) + "," + y(d.value.count) + ")"; })
              .attr("x", 3)
              .attr("dx", "-1em")
              .attr("dy", "0em")
              .attr("fill", function(d) { return color(d.name); })
              .text(function(d) { return d.value.count+'%'; });
          };

          svg.append("text")
              .text(title)
              .attr("x", width/2)
              .attr("y", 0)
              .style("font-size", "1.9em")
              .attr("dx", "-2.5em")
              .attr("dy", "-2em");

        }).fail(function() {
          /* $("#engaged_risk_text").html('Error with risk_engaged'); */
        });

      $.post('/rpc/1/healthmetrics/', {'func': 'eligible', 'args': JSON.stringify([])}, function(data) {
          $("#eligible").html(data);

          data = JSON.parse(data);
          eligible = data;

          var margin = {top: 50, right: 20, bottom: 20, left: 20},
            width = 200 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

          var loc = "#total_pop";
          var layout = {};
              layout.margin = margin,
              layout.width = width,
              layout.height = height;

          var title = "Total Population";

          generateBarChart(loc, eligible, layout, title);
        }).fail(function() {
          $("#eligible").html('Error with eligibility rates');
        }); 

        $.post('/rpc/1/healthmetrics/', {'func': 'participating', 'args': JSON.stringify([])}, function(data) {
          $("#participating").html(data);
          
          var participated = JSON.parse(data);
          data = eligible;

          var margin = {top: 50, right: 20, bottom: 20, left: 20},
            width = 200 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

          var title = "Participated Rates";

          var x = d3.scale.ordinal().rangeRoundBands([0, width], .5);
          var y = d3.scale.linear().range([height, 0]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom")

          var yAxis = d3.svg.axis()
              .scale(y)
              .orient("left")
              .ticks(10);

          var svg = d3.select("#participation_rates").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", 
                    "translate(" + margin.left + "," + margin.top + ")");

          $.each(participated, function(i, item) {
            item.date = +item._id;
            item.value = +item.count;
            item.rate = Math.floor((item.count/data[i].count) * 100);
          });

          x.domain(data.map(function(d) { return d.date; }).sort());
          y.domain([0, d3.max(data, function(d) { return d.value; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
              .selectAll("text")
              .style("text-anchor", "end")
              .attr("dx", ".9em")

          var bar = svg.selectAll("bar")
              .data(data)
              .enter()

           bar.append("rect")
              .style("fill", "grey")
              .style("opacity", 0.1)
              .attr("x", function(d) { return x(d.date); })
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.value); })
              .attr("height", function(d) { return height - y(d.value); });

           svg.append("text")
              .text(title)
              .attr("x", width/2)
              .attr("y", 0)
              .attr("dx", "-4em")
              .attr("dy", "-2em");

           x.domain(participated.map(function(d) { return d.date; }).sort());

           participated = participated.sort(function(a, b){
            if (a._id > b._id) return 1;
            if (a._id < b._id) return -1;
            return 0;
           });

           svg.selectAll("bar")
              .data(participated)
              .enter().append("rect")
              .style("fill", "steelblue")
              .style("opacity", 0.9)
              .attr("x", function(d) { return x(d.date); })
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.value); })
              .attr("height", function(d) { return height - y(d.value); });

           svg.selectAll("bar")
              .data(participated)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", 0)
              .attr("dx", "-1em")
              .attr("dy", "-.3em")
              .text(function(d) { return d.rate+'%'; });
        }).fail(function() {
          $("#participating").html('Error with participation rates');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'engaged', 'args': JSON.stringify([])}, function(data) {
          $("#engaged").html(data);
          
          var engaged = JSON.parse(data);
          data = eligible;

          var margin = {top: 50, right: 20, bottom: 20, left: 20},
            width = 200 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

          var title = "Engaged Rates";

          var x = d3.scale.ordinal().rangeRoundBands([0, width], .5);
          var y = d3.scale.linear().range([height, 0]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom")

          var yAxis = d3.svg.axis()
              .scale(y)
              .orient("left")
              .ticks(10);

          var svg = d3.select("#engagement_rates").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", 
                    "translate(" + margin.left + "," + margin.top + ")");

          $.each(engaged, function(i, item) {
            item.date = +item._id;
            item.value = +item.count;
            item.rate = Math.floor((item.count/data[i].count) * 100);
          });

          x.domain(data.map(function(d) { return d.date; }).sort());
          y.domain([0, d3.max(data, function(d) { return d.value; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis)
              .selectAll("text")
              .style("text-anchor", "end")
              .attr("dx", ".9em")

          var bar = svg.selectAll("bar")
              .data(data)
              .enter()

           bar.append("rect")
              .style("fill", "grey")
              .style("opacity", 0.1)
              .attr("x", function(d) { return x(d.date); })
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.value); })
              .attr("height", function(d) { return height - y(d.value); });

           svg.append("text")
              .text(title)
              .attr("x", width/2)
              .attr("y", 0)
              .attr("dx", "-4em")
              .attr("dy", "-2em");

           x.domain(engaged.map(function(d) { return d.date; }).sort());

           engaged = engaged.sort(function(a, b){
            if (a._id > b._id) return 1;
            if (a._id < b._id) return -1;
            return 0;
           });

           svg.selectAll("bar")
              .data(engaged)
              .enter().append("rect")
              .style("fill", "steelblue")
              .style("opacity", 0.9)
              .attr("x", function(d) { return x(d.date); })
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.value); })
              .attr("height", function(d) { return height - y(d.value); });

           svg.selectAll("bar")
              .data(engaged)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", 0)
              .attr("dx", "-1em")
              .attr("dy", "-.3em")
              .text(function(d) { return d.rate+'%'; });
        }).fail(function() {
          $("#engaged").html('Error with engaged');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'members_participating', 'args': JSON.stringify([])}, function(data) {
		$("#members_participating").html(data);
        }).fail(function() {
          $("#members_participating").html('Error with members_participating');
        });
        $.post('/rpc/1/healthmetrics/', {'func': 'expenses_participating', 'args': JSON.stringify([])}, function(data) {
          $("#expenses_participating").html(data);

          data = JSON.parse(data);

          var margin = {top: 50, right: 20, bottom: 20, left: 20},
            width = 200 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

          var loc = "#participant_pmpm";
          var layout = {};
              layout.margin = margin,
              layout.width = width,
              layout.height = height;

          var title = "Participant PMPM";

          var x = d3.scale.ordinal().rangeRoundBands([0, width], .5);
          var y = d3.scale.linear().range([height, 0]);

          var xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom");

          var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(10);

          var svg = d3.select(loc).append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          $.each(data, function(i, item) {
            item.date = +item._id;
            item.value = Math.floor(+item.dollars);
          });
          data = data.sort(function(a, b){
            if (a._id > b._id) return 1;
            if (a._id < b._id) return -1;
            return 0;
           });

          x.domain(data.map(function(d) { return d.date; }).sort());
          y.domain([0, d3.max(data, function(d) { return d.value; })]);

          svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "1.1em")

          var bar = svg.selectAll("bar")
                 .data(data)
                 .enter()

          bar.append("rect")
             .style("fill", "steelblue")
             .style("opacity", 0.9)
             .attr("x", function(d) { return x(d.date); })
             .attr("width", x.rangeBand())
             .attr("y", function(d) { return y(d.value); })
             .attr("height", function(d) { return height - y(d.value); });

          bar.append("text")
             .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
             .attr("y", 0)
             .attr("dx", "-1.2em")
             .attr("dy", "-.3em")
             .text(function(d) { return '$'+d.value; });

          svg.append("text")
             .text(title)
             .attr("x", width/2)
             .attr("y", 0)
             .attr("dx", "-3.5em")
             .attr("dy", "-2em");
        }).fail(function() {
          $("#expenses_participating").html('Error with expenses_participating');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'members_non_participating', 'args': JSON.stringify([])}, function(data) {
          $("#members_non_participating").html(data);
        }).fail(function() {
          $("#members_non_participating").html('Error with members_all');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'expenses_non_participating', 'args': JSON.stringify([])}, function(data) {
          $("#expenses_non_participating").html(data);

          data = JSON.parse(data);

          var margin = {top: 50, right: 20, bottom: 20, left: 20},
            width = 200 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

          var loc = "#non-participant_pmpm";
          var layout = {};
              layout.margin = margin,
              layout.width = width,
              layout.height = height;

          var title = "Non-Participant PMPM";

          var x = d3.scale.ordinal().rangeRoundBands([0, width], .5);
          var y = d3.scale.linear().range([height, 0]);

          var xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom");

          var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(10);

          var svg = d3.select(loc).append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          $.each(data, function(i, item) {
            item.date = +item._id;
            item.value = Math.floor(+item.dollars);
          });
          data = data.sort(function(a, b){
            if (a._id > b._id) return 1;
            if (a._id < b._id) return -1;
            return 0;
           });

          x.domain(data.map(function(d) { return d.date; }).sort());
          y.domain([0, d3.max(data, function(d) { return d.value; })]);

          svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "1.1em")

          var bar = svg.selectAll("bar")
                 .data(data)
                 .enter()

          bar.append("rect")
             .style("fill", "steelblue")
             .style("opacity", 0.9)
             .attr("x", function(d) { return x(d.date); })
             .attr("width", x.rangeBand())
             .attr("y", function(d) { return y(d.value); })
             .attr("height", function(d) { return height - y(d.value); });

          bar.append("text")
             .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
             .attr("y", 0)
             .attr("dx", "-1.2em")
             .attr("dy", "-.3em")
             .text(function(d) { return '$'+d.value; });

          svg.append("text")
             .text(title)
             .attr("x", width/2)
             .attr("y", 0)
             .attr("dx", "-5.3em")
             .attr("dy", "-2em");
        }).fail(function() {
          $("#expenses_non_participating").html('Error with expenses_all');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'members_engaged', 'args': JSON.stringify([])}, function(data) {
          $("#members_engaged").html(data);
        }).fail(function() {
          $("#members_engaged").html('Error with members_engaged');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'expenses_engaged', 'args': JSON.stringify([])}, function(data) {
          $("#expenses_engaged").html(data);

          data = JSON.parse(data);

          var margin = {top: 50, right: 20, bottom: 20, left: 20},
            width = 200 - margin.left - margin.right,
            height = 200 - margin.top - margin.bottom;

          var loc = "#engaged_pmpm";
          var layout = {};
              layout.margin = margin,
              layout.width = width,
              layout.height = height;

          var title = "Engaged PMPM";

          var x = d3.scale.ordinal().rangeRoundBands([0, width], .5);
          var y = d3.scale.linear().range([height, 0]);

          var xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom");

          var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(10);

          var svg = d3.select(loc).append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          $.each(data, function(i, item) {
            item.date = +item._id;
            item.value = Math.floor(+item.dollars);
          });
          data = data.sort(function(a, b){
            if (a._id > b._id) return 1;
            if (a._id < b._id) return -1;
            return 0;
           });

          x.domain(data.map(function(d) { return d.date; }).sort());
          y.domain([0, d3.max(data, function(d) { return d.value; })]);

          svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis)
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "1.1em")

          var bar = svg.selectAll("bar")
                 .data(data)
                 .enter()

          bar.append("rect")
             .style("fill", "steelblue")
             .style("opacity", 0.9)
             .attr("x", function(d) { return x(d.date); })
             .attr("width", x.rangeBand())
             .attr("y", function(d) { return y(d.value); })
             .attr("height", function(d) { return height - y(d.value); });

          bar.append("text")
             .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
             .attr("y", 0)
             .attr("dx", "-1.2em")
             .attr("dy", "-.3em")
             .text(function(d) { return '$'+d.value; });

          svg.append("text")
             .text(title)
             .attr("x", width/2)
             .attr("y", 0)
             .attr("dx", "-3.0em")
             .attr("dy", "-2em");
        }).fail(function() {
          $("#expenses_engaged").html('Error with expenses_engaged');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'figure_3', 'args': JSON.stringify([])}, function(data) {
          $("#figure3").html(data);

          var margin = {top: 70, right: 120, bottom: 20, left: 30},
              width = 300 - margin.left - margin.right,
              height = 200 - margin.top - margin.bottom;

          var x = d3.scale.ordinal()
              .rangeRoundBands([0, width], .5);

          var y = d3.scale.linear()
              .rangeRound([height, 0]);

          var color = d3.scale.ordinal()
              .range(["steelblue", "#BDBDBD", "#F78181"]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");

          var loc = "#total_population_claims";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          data = JSON.parse(data);
          color.domain(d3.keys(data[0]).filter(function(key) { return key !== "Year"; }));

          $.each(data, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });

          data = data.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(data.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(data, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(data)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          var legend = svg.selectAll(".legend")
              .data(color.domain().slice().reverse())
              .enter().append("g")
              .attr("class", "legend")
              .attr("transform", function(d, i) { return "translate(20," + i * 20 + ")"; });

          legend.append("text")
              .attr("x", width+80)
              .attr("y", -50)
              .attr("dy", "0em")
              .style("text-anchor", "end")
              .style("fill", color)
              .text(function(d) { return 'claims ' + d; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.over_10k+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.between+'%'; });

          svg.selectAll("claims")
              .data(data)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.under_500+'%'; });

        }).fail(function() {
          $("#figure3").html('Error with figure_3');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'risk_participating_changes', 'args': JSON.stringify([])}, function(data) {
          //$("#risk_participating_changes div").html(data);
          
          data = JSON.parse(data);

          var title = "Changes in Risk for Participants";
          var loc = "#changes_risk_participants";

          var units = "People";

          var margin = {top: 70, right: 80, bottom: 80, left: 40},
              width = 400 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

          var formatNumber = d3.format(",.0f"),    // zero decimal places
              format = function(d) { return formatNumber(d) + " " + units; },
              color = d3.scale.ordinal().range(["#F78181", "#BDBDBD", "steelblue"]);

          // append the svg canvas to the page
          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          // Set the sankey diagram properties
          var sankey = d3.sankey()
              .nodeWidth(30)
              .nodePadding(45)
              .size([width, height]);

          var path = sankey.link();

          var graph = {"nodes" : [], "links" : []};
          var years = new Set();

          $.each(data, function (i, d) {
            graph.nodes.push({ "name": d.SourceYear + ' ' + d.Source });
            graph.nodes.push({ "name": d.TargetYear + ' ' + d.Target });
            graph.links.push({ "source": d.SourceYear + ' ' + d.Source,
                             "target": d.TargetYear + ' ' + d.Target,
                             "value": +d.Count });
            years.add(d.SourceYear);
            years.add(d.TargetYear);
          });

          graph.nodes = graph.nodes.sort(function(a, b) { 
              if (a.name.slice(0,5) > b.name.slice(0,5)) return -1;
              if (a.name.slice(0,5) < b.name.slice(0,5)) return 1;
              if (a.name.slice(5,6) == 'H') return -1;
              if (a.name.slice(5,6) == 'L') return 1;
              if (a.name.slice(5,6) == 'M' && b.name.slice(5,6) == 'H') return 1;
              if (a.name.slice(5,6) == 'M' && b.name.slice(5,6) == 'L') return -1;
              return 0;
          });

          // return only the distinct / unique nodes
          graph.nodes = d3.keys(d3.nest()
            .key(function (d) { return d.name; })
            .map(graph.nodes));


          // loop through each link replacing the text with its index from node
          graph.links.forEach(function (d, i) {
            graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
            graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
          });

          //now loop through each nodes to make nodes an array of objects
          // rather than an array of strings
          graph.nodes.forEach(function (d, i) {
            graph.nodes[i] = { "name": d };
          }); 

          sankey
            .nodes(graph.nodes)
            .links(graph.links)
            .layout(32);

          // add in the links
          var link = svg.append("g").selectAll(".link")
            .data(graph.links)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .style("stroke-width", function(d) { return Math.max(1, d.dy); })
            .sort(function(a, b) { return b.dy - a.dy; });

          // add the link titles
          link.append("title")
            .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });

          // add in the nodes
          var node = svg.append("g").selectAll(".node")
            .data(graph.nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { 
            return "translate(" + d.x + "," + d.y + ")"; })
            .call(d3.behavior.drag()
            .origin(function(d) { return d; })
            .on("dragstart", function() { 
            this.parentNode.appendChild(this); })
            .on("drag", dragmove));     

          // add the rectangles for the nodes
          node.append("rect")
            .attr("height", function(d) { return d.dy; })
            .attr("width", sankey.nodeWidth())
            //.style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
            .style("fill", function(d, i) { return d.color = color(i%3); })
            .style("opacity", 0.9)
            .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
            .append("title")
            .text(function(d) { 
            return d.name + "\n" + format(d.value); }); 

          // add in the title for the nodes
          node.append("text")
            //.attr("x", -6)
            .attr("y", function(d) { return d.dy / 2; })
            //.attr("dx", "1em")
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function(d) { return d.name.slice(4); })
            //.filter(function(d) { return d.x < width / 2; })
            .attr("x", 5+sankey.nodeWidth())
            .style("font-size", ".7em")
            .attr("text-anchor", "start");

          years = Array.from(years);

          svg.selectAll(".text")
            .data(years)
            .enter().append("text")
            .attr("x", function(d, i) { return (1.2*i)*(width/(years.length));})
            .attr("y", 50-margin.top)
            .attr("dx", ".1em")
            .style("font-size","0.8em")
            .text(function(d) { return d; });

          svg.selectAll(".text")
            .data(years)
            .enter().append("text")
            .attr("x", width/2)
            .attr("y", 20-margin.top)
            .attr("dx", "-6em")
            .style("font-size","0.9em")
            .text(title);

          // the function for moving the nodes
          function dragmove(d) {
            d3.select(this).attr("transform", 
                "translate(" + d.x + "," + (
                      d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
                  ) + ")");
            sankey.relayout();
            link.attr("d", path);
          }


        }).fail(function() {
          $("#figure3").html('Error with figure_3');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'risk_engaged_changes', 'args': JSON.stringify([])}, function(data) {
          //$("#risk_engaged_changes div").html(data);

          data = JSON.parse(data);

          var title = "Changes in Risk for Engaged";
          var loc = "#changes_risk_engaged";

          var units = "People";

          var margin = {top: 70, right: 80, bottom: 80, left: 40},
              width = 400 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

          var formatNumber = d3.format(",.0f"),    // zero decimal places
              format = function(d) { return formatNumber(d) + " " + units; },
              color = d3.scale.ordinal().range(["#F78181", "#BDBDBD", "steelblue"]);

          // append the svg canvas to the page
          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          // Set the sankey diagram properties
          var sankey = d3.sankey()
              .nodeWidth(30)
              .nodePadding(45)
              .size([width, height]);

          var path = sankey.link();

          var graph = {"nodes" : [], "links" : []};
          var years = new Set();

          $.each(data, function (i, d) {
            graph.nodes.push({ "name": d.SourceYear + ' ' + d.Source });
            graph.nodes.push({ "name": d.TargetYear + ' ' + d.Target });
            graph.links.push({ "source": d.SourceYear + ' ' + d.Source,
                             "target": d.TargetYear + ' ' + d.Target,
                             "value": +d.Count });
            years.add(d.SourceYear);
            years.add(d.TargetYear);
          });

          graph.nodes = graph.nodes.sort(function(a, b) { 
              if (a.name.slice(0,5) > b.name.slice(0,5)) return -1;
              if (a.name.slice(0,5) < b.name.slice(0,5)) return 1;
              if (a.name.slice(5,6) == 'H') return -1;
              if (a.name.slice(5,6) == 'L') return 1;
              if (a.name.slice(5,6) == 'M' && b.name.slice(5,6) == 'H') return 1;
              if (a.name.slice(5,6) == 'M' && b.name.slice(5,6) == 'L') return -1;
              return 0;
          });

          // return only the distinct / unique nodes
          graph.nodes = d3.keys(d3.nest()
            .key(function (d) { return d.name; })
            .map(graph.nodes));


          // loop through each link replacing the text with its index from node
          graph.links.forEach(function (d, i) {
            graph.links[i].source = graph.nodes.indexOf(graph.links[i].source);
            graph.links[i].target = graph.nodes.indexOf(graph.links[i].target);
          });

          //now loop through each nodes to make nodes an array of objects
          // rather than an array of strings
          graph.nodes.forEach(function (d, i) {
            graph.nodes[i] = { "name": d };
          }); 

          sankey
            .nodes(graph.nodes)
            .links(graph.links)
            .layout(32);

          // add in the links
          var link = svg.append("g").selectAll(".link")
            .data(graph.links)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", path)
            .style("stroke-width", function(d) { return Math.max(1, d.dy); })
            .sort(function(a, b) { return b.dy - a.dy; });

          // add the link titles
          link.append("title")
            .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });

          // add in the nodes
          var node = svg.append("g").selectAll(".node")
            .data(graph.nodes)
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { 
            return "translate(" + d.x + "," + d.y + ")"; })
            .call(d3.behavior.drag()
            .origin(function(d) { return d; })
            .on("dragstart", function() { 
            this.parentNode.appendChild(this); })
            .on("drag", dragmove));     

          // add the rectangles for the nodes
          node.append("rect")
            .attr("height", function(d) { return d.dy; })
            .attr("width", sankey.nodeWidth())
            //.style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
            .style("fill", function(d, i) { return d.color = color(i%3); })
            .style("opacity", 0.9)
            .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
            .append("title")
            .text(function(d) { 
            return d.name + "\n" + format(d.value); }); 

          // add in the title for the nodes
          node.append("text")
            //.attr("x", -6)
            .attr("y", function(d) { return d.dy / 2; })
            //.attr("dx", "1em")
            .attr("dy", ".35em")
            .attr("text-anchor", "end")
            .attr("transform", null)
            .text(function(d) { return d.name.slice(4); })
            //.filter(function(d) { return d.x < width / 2; })
            .attr("x", 5+sankey.nodeWidth())
            .style("font-size", ".7em")
            .attr("text-anchor", "start");

          years = Array.from(years);

          svg.selectAll(".text")
            .data(years)
            .enter().append("text")
            .attr("x", function(d, i) { return (1.2*i)*(width/(years.length));})
            .attr("y", 50-margin.top)
            .attr("dx", ".1em")
            .style("font-size","0.8em")
            .text(function(d) { return d; });

          svg.selectAll(".text")
            .data(years)
            .enter().append("text")
            .attr("x", width/2)
            .attr("y", 20-margin.top)
            .attr("dx", "-6em")
            .style("font-size","0.9em")
            .text(title);

          // the function for moving the nodes
          function dragmove(d) {
            d3.select(this).attr("transform", 
                "translate(" + d.x + "," + (
                      d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
                  ) + ")");
            sankey.relayout();
            link.attr("d", path);
          }
        }).fail(function() {
          $("#figure3").html('Error with figure_3');
        });

        $.post('/rpc/1/healthmetrics/', {'func': 'improved_biometrics', 'args': JSON.stringify([])}, function(data) {

          data = JSON.parse(data);
          var title = Object.keys(data[0])[0];
          var value = data[0][title]
          $("#biom1_participants p").html(title);
          //$("#biom1_participants div").html(JSON.stringify(value));


          var margin = {top: 70, right: 120, bottom: 20, left: 30},
              width = 300 - margin.left - margin.right,
              height = 200 - margin.top - margin.bottom;

          var x = d3.scale.ordinal()
              .rangeRoundBands([0, width], .5);

          var y = d3.scale.linear()
              .rangeRound([height, 0]);

          var color = d3.scale.ordinal()
              .range(["steelblue", "#BDBDBD", "#F78181"]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");

          var loc = "#biom1_participants";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          color.domain(d3.keys(value[0]).filter(function(key) { return key !== "Year"; }));

          $.each(value, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });
          console.log(value);

          value = value.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(value.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(value, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(value)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.critical+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.outofNormal+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.normal+'%'; });


/*--------------------------------------------------------------------------------*/
          title = Object.keys(data[1])[0];
          value = data[1][title]
          $("#biom1_engaged p").html(title);
          //$("#biom1_engaged div").html(JSON.stringify(value));

          var loc = "#biom1_engaged";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          color.domain(d3.keys(value[0]).filter(function(key) { return key !== "Year"; }));

          $.each(value, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });
          console.log(value);

          value = value.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(value.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(value, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(value)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.critical+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.outofNormal+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.normal+'%'; });

/*--------------------------------------------------------------------------------*/

          title = Object.keys(data[2])[0];
          value = data[2][title]
          $("#biom2_participants p").html(title);
          //$("#biom2_participants div").html(JSON.stringify(value));

          var loc = "#biom2_participants";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          color.domain(d3.keys(value[0]).filter(function(key) { return key !== "Year"; }));

          $.each(value, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });
          console.log(value);

          value = value.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(value.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(value, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(value)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.critical+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.outofNormal+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.normal+'%'; });

/*--------------------------------------------------------------------------------*/

          title = Object.keys(data[3])[0];
          value = data[3][title]
          $("#biom2_engaged p").html(title);
          //$("#biom2_engaged div").html(JSON.stringify(value));

          var loc = "#biom2_engaged";

          var svg = d3.select(loc).append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          color.domain(d3.keys(value[0]).filter(function(key) { return key !== "Year"; }));

          $.each(value, function(i, d) {
            var y0 = 0;
            d.claims = color.domain().map(function(level) { return {level: level, y0: y0, y1: y0 += +d[level]}; });
            d.total = d.claims[d.claims.length - 1].y1;
          });
          console.log(value);

          value = value.sort(function(a, b) { 
            if (a.Year > b.Year) return 1;
            if (a.Year < b.Year) return -1;
            return 0;
          });

          x.domain(value.map(function(d) { return d.Year; }));
          y.domain([0, d3.max(value, function(d) { return d.total; })]);

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

          var claims = svg.selectAll("claims")
              .data(value)
              .enter().append("g")
              .attr("class", "g")
              .attr("transform", function(d) { return "translate(" + x(d.Year) + ",0)"; });

          claims.selectAll("rect")
              .data(function(d) { return d.claims; })
            .enter().append("rect")
              .attr("width", x.rangeBand())
              .attr("y", function(d) { return y(d.y1); })
              .attr("height", function(d) { return y(d.y0) - y(d.y1); })
              .style("opacity", 0.9)
              .style("fill", function(d) { return color(d.level); });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 20-margin.top; })
              .attr("fill", "#F78181")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.critical+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 40-margin.top; })
              .attr("fill", "#BDBDBD")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.outofNormal+'%'; });

          svg.selectAll("claims")
              .data(value)
              .enter().append("text")
              .attr("x", function(d, i) { return 1.5*x.rangeBand()+x.rangeBand()*2*i;})
              .attr("y", function(d, i) { return 60-margin.top; })
              .attr("fill", "steelblue")
              .attr("dx", "-0.9em")
              .attr("dy", "0em")
              .text(function(d) { return d.normal+'%'; });

        }).fail(function() {
          $("#figure3").html('Error with improved_biometrics');
        });

{% endblock %}  <!-- loadscript -->
{% block pagescript %}
  <script type="text/javascript">
    $('#hm-tabs a').click(function (e) {
      e.preventDefault();
      $("#pi").hide();
      $("#op").hide();
      $("#ep").hide();
      $(this).tab('show');
      $(this.hash).show();
    })
  </script>
{% endblock %}

